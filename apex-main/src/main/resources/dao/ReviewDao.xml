<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.apex.app.dao.ReviewDao">

    <select id="getSubmissionCount" resultType="java.lang.Integer">
        select count(*)
        from submission_base s
        where s.org_id = #{org_id}
    </select>

    <select id="getSubmissionIdList" resultType="java.lang.String">
        select id
        from submission_base s
        where s.org_id = #{org_id}
    </select>

    <insert id="insertPaperAllocation">
        insert into paper_allocation
        (user_id, submission_id, org_id)
        values
        <foreach collection="allocationList" item="allocation" separator=",">
            (#{allocation.userId}, #{allocation.submissionId}, #{allocation.orgId})
        </foreach>
    </insert>

    <delete id="deleteAllocationByOrgId">
        delete
        from paper_allocation
        where org_id = #{org_id}
    </delete>

    <resultMap id="AllocationResultMap" type="com.apex.app.domain.bo.PaperAllocationMapBo">
        <id column="submission_id" property="submissionId"/>
        <collection property="userList" ofType="com.apex.app.domain.model.UserBase">
            <id column="user_id" property="id"/>
            <result column="fullName" property="fullName"/>
            <result column="firstName" property="firstName"/>
            <result column="lastName" property="lastName"/>
            <result column="email" property="email"/>
            <result column="avatar" property="avatar"/>
            <result column="title" property="title"/>
            <result column="enableStatus" property="enableStatus"/>
        </collection>
    </resultMap>

    <select id="getAllocationResult" resultMap="AllocationResultMap">
        select pa.submission_id,
               pa.user_id,
               ub.email,
               ub.full_name fullName,
               ub.last_name lastName,
               ub.first_name firstName,
               ub.avatar,
               ub.title,
               ub.enable_status enableStatus
        from paper_allocation pa
                 left join user_base ub on ub.id = pa.user_id
        where org_id = #{org_id}
    </select>

    <resultMap id="BaseResultMap" type="com.apex.app.domain.model.ReviewTaskOverall">
        <id column="id" jdbcType="VARCHAR" property="id" />
        <result column="org_id" jdbcType="VARCHAR" property="orgId" />
        <result column="submission_id" jdbcType="VARCHAR" property="submissionId" />
        <result column="status" jdbcType="TINYINT" property="status" />
        <result column="deadline" jdbcType="TIMESTAMP" property="deadline" />
        <result column="decision" jdbcType="TINYINT" property="decision" />
        <result column="created_time" jdbcType="TIMESTAMP" property="createdTime" />
    </resultMap>

    <resultMap id="ReviewTaskResultMap" type="com.apex.app.domain.bo.ReviewTaskInfoBo" extends="BaseResultMap">
        <association property="submissionInfo" javaType="com.apex.app.domain.model.SubmissionBase">
            <id column="submission_id" property="id"/>
            <result property="title" column="title" />
            <result property="abstract" column="abstract" />
            <result property="keywords" column="keywords" />
            <result property="resourceUrl" column="resource_url"/>
            <result property="publishedTime" column="published_time"/>
            <result property="authors" column="authors"/>
            <result property="contactEmail" column="contact_email"/>
            <result property="orgId" column="org_id"/>
        </association>
    </resultMap>
    
    <select id="getReviewTaskByUserId" resultMap="ReviewTaskResultMap">
        select rt.id,
               rt.org_id,
               rt.submission_id,
               rt.status,
               rt.deadline,
               rt.decision,
               rt.created_time,
               s.title,
               s.abstracts,
               s.keywords,
               s.resource_url,
               s.published_time,
               s.authors,
               s.contact_email,
               s.org_id
        from paper_allocation pa
            left join submission_base s on s.id = pa.submission_id
            left join review_task_overall rt on pa.submission_id = rt.submission_id
        where pa.org_id = #{org_id} and pa.user_id = #{user_id}
    </select>

</mapper>